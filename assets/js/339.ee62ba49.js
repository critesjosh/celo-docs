(window.webpackJsonp=window.webpackJsonp||[]).push([[339],{686:function(e,t,a){"use strict";a.r(t);var s=a(42),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"using-a-cloud-hsm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#using-a-cloud-hsm"}},[e._v("#")]),e._v(" Using a Cloud HSM")]),e._v(" "),a("p",[e._v("A cloud Hardware Security Module (HSM) provides a good balance between security and accessibility. A cloud HSM can manage a Celo private key and can be used seamlessly with "),a("code",[e._v("celocli")]),e._v(" and "),a("code",[e._v("contractkit")]),e._v(". Similar to a ledger device, a key in an HSM avoids the key from ever being sent over the network or stored on disk since the key can never leave the hardware boundary and all signing is performed within the HSM. To authenticate to the HSM, it's recommended to create a service principal account that has been granted access to sign with the managed keys. A cloud HSM can be a great option for managing vote signer keys, since you may want these keys to be portable but also maintain good security practices. This guide will walk you through creating a cloud HSM in Azure and connecting it to "),a("code",[e._v("celocli")]),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"create-an-azure-subscription"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-an-azure-subscription"}},[e._v("#")]),e._v(" Create an Azure subscription")]),e._v(" "),a("p",[e._v("If you don't have an Azure subscription already, you can "),a("a",{attrs:{href:"https://azure.microsoft.com/free/",target:"_blank",rel:"noopener noreferrer"}},[e._v("create a free trial here"),a("OutboundLink")],1),e._v(" that starts with $200 credit. You can "),a("a",{attrs:{href:"https://azure.microsoft.com/pricing/details/key-vault/",target:"_blank",rel:"noopener noreferrer"}},[e._v("view the pricing for Eliptic Curve Cryptography (ECC) HSM keys here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("h2",{attrs:{id:"deploy-your-azure-key-vault"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy-your-azure-key-vault"}},[e._v("#")]),e._v(" Deploy your Azure Key Vault")]),e._v(" "),a("p",[e._v("The Key Vault can store keys, secrets, and certificates. Permission can be specified to perform certain actions across the entire Key Vault (ex. key signing).")]),e._v(" "),a("ul",[a("li",[e._v('Search the marketplace for "Key Vault"')]),e._v(" "),a("li",[e._v("Click Create and fill out the deployment information")]),e._v(" "),a("li",[e._v("Ensure you select the Premium pricing tier for HSM support")]),e._v(" "),a("li",[e._v("Enable soft-delete and purge protection to ensure your keys aren't accidentally deleted")])]),e._v(" "),a("h2",{attrs:{id:"create-your-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-your-key"}},[e._v("#")]),e._v(" Create your key")]),e._v(" "),a("p",[e._v("Next, we'll create the ECDSA key.")]),e._v(" "),a("ul",[a("li",[e._v("Navigate to your newly created Key Vault and click on the "),a("code",[e._v("Keys")]),e._v(" section.")]),e._v(" "),a("li",[e._v('Click on "Generate/Import"')]),e._v(" "),a("li",[e._v('Select "EC-HSM"')]),e._v(" "),a("li",[e._v('Select "SECP256K1"')])]),e._v(" "),a("p",[e._v("You'll see your newly generated key listed in the "),a("code",[e._v("Keys")]),e._v(" section.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# On your local machine")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AZURE_VAULT_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("VAULT-NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AZURE_KEY_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("KEY-NAME"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("h2",{attrs:{id:"create-a-service-principal"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-service-principal"}},[e._v("#")]),e._v(" Create a Service Principal")]),e._v(" "),a("p",[e._v("A Service Principal (SP) is preferred over your personal account so that permission can be heavily restricted. In general, Service Principal accounts should be used for any automation or services that need to access Azure resources.")]),e._v(" "),a("p",[e._v("Use the "),a("a",{attrs:{href:"https://shell.azure.com/bash",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cloud Shell"),a("OutboundLink")],1),e._v(" to create the client credentials.")]),e._v(" "),a("p",[e._v("Create a service principal and configure its access to Azure resources:")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# In the Cloud Shell")]),e._v("\naz ad sp create-for-rbac -n "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-application-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" --skip-assignment\n")])])]),a("p",[e._v("The account will be created and will output the account's credentials.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"appId"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"generated-app-ID"')]),e._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"displayName"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"dummy-app-name"')]),e._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"http://dummy-app-name"')]),e._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"password"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"random-password"')]),e._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"tenant"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"tenant-ID"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),a("p",[e._v("Set these as environment variables so that they can be used by "),a("code",[e._v("celocli")]),e._v(" or "),a("code",[e._v("contractkit")]),e._v(".")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# On your local machine")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AZURE_CLIENT_ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("GENERATED-APP-ID"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AZURE_CLIENT_SECRET")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("PASSWORD"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("export")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("AZURE_TENANT_ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("TENANT-ID"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),a("h2",{attrs:{id:"grant-your-service-principal-access-to-the-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grant-your-service-principal-access-to-the-key"}},[e._v("#")]),e._v(" Grant your Service Principal access to the key")]),e._v(" "),a("p",[e._v("In the Cloud Shell or Access Policies pane of the Key Vault, set the [GET, LIST, SIGN] permission for the new account.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# In the Cloud Shell")]),e._v("\naz keyvault set-policy --name "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("your-key-vault-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" --spn "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$AZURE_CLIENT_ID")]),e._v(" --key-permissions get list sign\n")])])]),a("h2",{attrs:{id:"connecting-celocli-to-keyvault"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connecting-celocli-to-keyvault"}},[e._v("#")]),e._v(" Connecting CeloCLI to KeyVault")]),e._v(" "),a("p",[e._v("Now that your environment variables are set, we just need to let "),a("code",[e._v("celocli")]),e._v(" know that we want to use this Key Vault signer. We do this by passing in the flag "),a("code",[e._v("--useAKV")]),e._v(" and "),a("code",[e._v("--azureVaultName")]),e._v(". Similar to "),a("code",[e._v("--useLedger")]),e._v(", all CLI commands will use the HSM signer when "),a("code",[e._v("--useAKV")]),e._v(" is specified.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# On your local machine")]),e._v("\ncelocli account:list --useAKV --azureVaultName "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$AZURE_VAULT_NAME")]),e._v("\n")])])]),a("p",[e._v('Your Key Vault address will show up under "Local Addresses". If you\'d like to use this key as your vote signer key, you can follow '),a("RouterLink",{attrs:{to:"/docs/celo-holder-guide/quick-start.html#authorize-vote-signer-keys"}},[e._v("this guide")]),e._v(" and replace "),a("code",[e._v("--useLedger")]),e._v(" with "),a("code",[e._v("--useAKV --azureVaultName $AZURE_VAULT_NAME")]),e._v(".")],1),e._v(" "),a("h2",{attrs:{id:"connecting-contractkit-to-keyvault"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connecting-contractkit-to-keyvault"}},[e._v("#")]),e._v(" Connecting ContractKit to KeyVault")]),e._v(" "),a("p",[e._v("To leverage your HSM keys in "),a("code",[e._v("contractkit")]),e._v(", first create an "),a("code",[e._v("AzureHSMWallet")]),e._v(" object and use it to create a "),a("code",[e._v("ContractKit")]),e._v(" object with "),a("code",[e._v("newKitFromWeb3")]),e._v(". Note that "),a("code",[e._v("AzureHSMWallet")]),e._v(" expects AZURE_CLIENT_ID, AZURE_CLIENT_SECRET, and AZURE_TENANT_ID environment variables to be specified.")]),e._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" ContractKit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" newKitFromWeb3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("from")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'@celo/contractkit'")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" AzureHSMWallet "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("from")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'@celo/contractkit/lib/wallets/azure-hsm-wallet'")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" azureVaultName "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"AZURE-VAULT-NAME"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" akvWallet "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("AzureHSMWallet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("azureVaultName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" akvWallet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\nconsole"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[e._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("Found addresses: ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("${")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" akvWallet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("getAccounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[e._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" contractKit "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("newKitFromWeb3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("web3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" akvWallet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),a("h2",{attrs:{id:"summary"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[e._v("#")]),e._v(" Summary")]),e._v(" "),a("p",[e._v("You can now leverage a cloud HSM key to perform signing as a user or application. This improves both security and availability of your Celo keys. We also recommend enabling two-factor authentication across your Azure subscription and to leverage "),a("a",{attrs:{href:"https://docs.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview",target:"_blank",rel:"noopener noreferrer"}},[e._v("Managed Service Identities"),a("OutboundLink")],1),e._v(" where possible.")])])}),[],!1,null,null,null);t.default=r.exports}}]);